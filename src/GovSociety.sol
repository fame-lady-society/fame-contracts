// SPDX-License-Identifier: MIT
// Compatible with OpenZeppelin Contracts ^5.0.0
//                                         #*==+**
//                                          *::---+#@
//                                          +::--:-+##
//                                         %=::-:::=++#
//                                         #---::::-==+
//                                         *-:-::::==-+%
//                                         =:::::.:=--+#
//                                        %=:-::::-=:-=*
//                                        #-:-::.:--::=+
//                                        *:-::::-=-:--=
//                                       %-:-:::===----=%
//                                       #::::::==-----=
//                                       %#+-::=+=-----+#*---:---=*
//                                       +=++*+===----::::::::-----=#
//                                      @=-:::---=---::::::::------:+#
//                                       =-:..:===----::::=+**-----:-+
//                                       =+==+=:+----::-=*   *-------+%
//                                       #+--:==+-----=*%    *-------+#
//                                        %=-.-=+----=*      *--=----+*
//                                         %++--+=-=+#       *===-===++
//                                            #++**%@        *=======+*
//                                                           *=======+*
//                                                          %*====++=+*
//                                                          %*===+++=+*
//                                                          %+===+++=*#
//                                                          #========*%                 ****#
//                                                          *========*%              #+=----=+##
//                                                          +=======+*             #+----------=*#
//                                                         %========+#           %*=-=#% %=-------+#
//                                                         #========*%          *+-=*%    *--------+*
//                                                         *=======+*%         #+-=*%     #---------+#
//                                                        #========+*         #*==+#      #=--------=#
//                                                       @*========+*        %#==+#       #=---=-----*
//                                                   %##*+--=======+#        #+==+#       *=--===----*#
//                                                   +==#+=========*#       #*===*%       *=======--==#
//                                                    %#%+-========*%      %*===+#        *-====--=+-:*
//                                                      #+=--======*#     %*+===+%       %=--::-=++=-+*
//                                                      #======-----+*%  %*+++==+#      %=:-:-=+==---=+
//                                                      *======-======*##*++++=+#      %=-=======++==*#
//                                                     %+=====--=========++====+@     %#++==-----+#*##
//                                                     *==-===--==--=======--*##      %*++**#+=+###%@
//                                                    #+==-==---==-=======---+++
//                                                    *==-===--=+**+======--=*=+
//                                                   %+--------*%   #*+===--++*%
//                                                  @#+===-:--=@
//                                                  #*==+===-*#
//                                                 %*+=======#
//                                                #*+======+*
//                                               %#+=======*
//                                               #++=====+#%
//                                              #++====+*%
//                                          %#**==+==+*%
//                                         *=:=+==+=*%%
//                                         #+-=+==*#%*+++#
//                                           %#*#%   *+==+#
//                                                   #+===#
//                                                  #*====#
//                                                 %*+====#
//                                                %*+====**
//                                                *+=====*
//                        =*%                    *+===--+*
//                       *+*#                   #+-==-:=*
//                      %%%%%%                 #*+===--+
//                     %%%%%%%                #++#%#*+*@
//                     ##%#**##              #-=+#%%%%
//                    %#*#***##             *--#%%%%%
//                    ++++=+++#            #****#%%%@
//                   #*+++**+#%           *******##@
//                   #****+=+#%         %#*++++**#@
//                   ++=+++==#%        %*++++++*#%
//                   %#*+===*#        #*+++++++%@
//                    ##*+=*%@       #*+++++=+**+==***#%%%%#####*##****###########%
//                       %#%@       #*+++++++++=-::=*######*************##########*==*%
//                              %#***++++++++++==-=***************#*****###########***+*%
//                          %#***+**+=++++++++++==******###############*###########*++=+*%
//                      %%*+=++++++++++=++++*****#%%%%                       %%%%%#*++=+*#%
//                  %*+=+*+=====++++++==+*#%@                    ####%%            @%#*+*##%
//                *=:...:---=--:-----:-=*                        #####*#%        %##*#*+*#*#
//             %*+-===++*+=++=---=***#%@                           %##*##%      %%#####%@%%@
//           ##*++=++++++++####*+*##*#%                           ####****%
//         #*=---=------=*****####%##%                            #######*#
//        *+==--=----=++ *++**####%%%                   %###%
//      *=--=-----=+    ==++#####%%@                    #***##%#%
//     *+-::--=+**     *+==+*####%                      %#*******#%
//    *=====++**      *++=-=*###%                        @%*******##@
//   *======+**     +=-=+=:=##%%                      %#***********#%
//  #======++      **=--+--*#%%                @%##**++++*######%%%%@
// %+======+      +==-=**+**#%             %#*******#%%%         %%#*##
// *=======*     *+++++*++*#             %*****#%%%           %#*****#%
// *======+    **+++==++=*%             %****#%            %##****##%%@%##%
// *======+****+++====++*%              #***#%          %##******###**####%
// %+======+**+++++++++%                %#*********+++**+*********#####%
//  #*====+**++++++***#                   %##****++==++*++**#####%%
//   #*+======----+##                       @%#**+=+**++*##%%@
//     #**++++++**%@                     @##******+*+++****##%%
//         %##%                      %#***********++==++******##%%
//                              %%****+++**********==+********##*#%
//                         %##***++++++++*****              ####*##%
//                        #*+++++++++++++*****#            *####*##%
//                        *++++++++++++++*********+       **#**###%
//                        %#**++*******+++**********+**********###
//                            @%%%% %#*+++***%%#**+==+**++****##%
//                                   #*+++******#*=+*****+****%
//                                   @#*++*********+********#%
//                                     %#********+-=******+*#
//                                       %###********##%%%***#
//                                             %%###      %%**#
//                                                          %*##
//                                                          %#*#%
//                                                           %###%
//                                                           %####
//                                                           %#*##@
//                                                           %**#*
//                                                           %**##
//                                                           #*##%
pragma solidity ^0.8.22;

import "@openzeppelin5/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin5/contracts/utils/cryptography/EIP712.sol";
import "@openzeppelin5/contracts/token/ERC721/extensions/ERC721Votes.sol";
import "@openzeppelin5/contracts/access/AccessControl.sol";
import "@openzeppelin5/contracts/token/ERC721/extensions/ERC721Wrapper.sol";
import {LibBitmap} from "solady/utils/LibBitmap.sol";

contract GovSociety is ERC721Wrapper, EIP712, ERC721Votes, AccessControl {
    using LibBitmap for LibBitmap.Bitmap;
    LibBitmap.Bitmap private _lockedTokensIds;
    mapping(uint256 => address) private _guardianForTokenId;
    bytes32 public constant RESCUE_ROLE = keccak256("RESCUE_ROLE");

    constructor(
        address underlyingToken,
        address defaultAdmin
    )
        ERC721Wrapper(IERC721(underlyingToken))
        ERC721("govSociety", "gFAME")
        EIP712("govSociety", "1")
    {
        _grantRole(DEFAULT_ADMIN_ROLE, defaultAdmin);
        _grantRole(RESCUE_ROLE, defaultAdmin);
    }

    function clock() public view override returns (uint48) {
        return uint48(block.timestamp);
    }

    // solhint-disable-next-line func-name-mixedcase
    function CLOCK_MODE() public pure override returns (string memory) {
        return "mode=timestamp";
    }

    modifier onlyTokenOwner(uint256 tokenId) {
        require(
            ownerOf(tokenId) == msg.sender,
            "Only token owner can call this function"
        );
        _;
    }

    error TokenIsAlreadyLocked(uint256 tokenId);

    function lock(uint256 tokenId) public onlyTokenOwner(tokenId) {
        if (isLocked(tokenId)) {
            revert TokenIsAlreadyLocked(tokenId);
        }
        _lockedTokensIds.set(tokenId);
    }

    function lockWithGuardian(
        uint256 tokenId,
        address guardian
    ) public onlyTokenOwner(tokenId) {
        if (isLocked(tokenId)) {
            revert TokenIsAlreadyLocked(tokenId);
        }
        _lockedTokensIds.set(tokenId);
        _guardianForTokenId[tokenId] = guardian;
    }

    // @dev if guardian exists, caller must be the guardian. otherwise they must be the owner
    error OnlyGuardianOrOwner(uint256 tokenId);
    modifier onlyGuardianOrOwner(uint256 tokenId) {
        address g = guardianForTokenId(tokenId);
        if (
            (g != address(0) && msg.sender != g) ||
            (g == address(0) && msg.sender != ownerOf(tokenId))
        ) {
            revert OnlyGuardianOrOwner(tokenId);
        }
        _;
    }
    error TokenIsNotLocked(uint256 tokenId);
    function unlock(uint256 tokenId) public onlyGuardianOrOwner(tokenId) {
        if (!isLocked(tokenId)) {
            revert TokenIsNotLocked(tokenId);
        }
        _lockedTokensIds.unset(tokenId);
        _guardianForTokenId[tokenId] = address(0);
    }

    function isLocked(uint256 tokenId) public view returns (bool) {
        return _lockedTokensIds.get(tokenId);
    }

    function guardianForTokenId(uint256 tokenId) public view returns (address) {
        return _guardianForTokenId[tokenId];
    }

    function lockedTokenCount(
        uint256 start,
        uint256 amount
    ) public view returns (uint256) {
        return _lockedTokensIds.popCount(start, amount);
    }

    error TokenIsLocked(uint256 tokenId);
    function transferFrom(
        address from,
        address to,
        uint256 tokenId
    ) public override {
        // Dissallow transfers of locked tokens
        if (isLocked(tokenId)) {
            revert TokenIsLocked(tokenId);
        }

        super.transferFrom(from, to, tokenId);
    }

    // The following functions are overrides required by Solidity.
    function _update(
        address to,
        uint256 tokenId,
        address auth
    ) internal override(ERC721, ERC721Votes) returns (address) {
        return super._update(to, tokenId, auth);
    }

    function _increaseBalance(
        address account,
        uint128 value
    ) internal override(ERC721, ERC721Votes) {
        super._increaseBalance(account, value);
    }

    function supportsInterface(
        bytes4 interfaceId
    ) public view override(ERC721, AccessControl) returns (bool) {
        return super.supportsInterface(interfaceId);
    }

    function rescue(
        address account,
        uint256 tokenId
    ) public onlyRole(RESCUE_ROLE) {
        _recover(account, tokenId);
    }
}
